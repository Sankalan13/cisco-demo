# Test Tracing Component
# Adds OpenTelemetry tracing infrastructure and configuration for local testing
# This component:
# - Deploys OpenTelemetry Collector and Jaeger
# - Enables tracing on all microservices (ENABLE_TRACING=1)
# - Configures services to send traces to the collector
# - Uses fixed Node.js service images with compatible OTel dependencies

apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
- otel-collector.yaml
- jaeger.yaml

# Override Node.js service images with locally-built versions containing OTel fixes
# These images have updated @opentelemetry/sdk-trace-node and exporter packages
# Override Go service images with coverage-instrumented versions
images:
- name: us-central1-docker.pkg.dev/google-samples/microservices-demo/currencyservice
  newName: currencyservice
  newTag: local-fixed
- name: us-central1-docker.pkg.dev/google-samples/microservices-demo/paymentservice
  newName: paymentservice
  newTag: local-fixed
- name: us-central1-docker.pkg.dev/google-samples/microservices-demo/productcatalogservice
  newName: productcatalogservice
  newTag: local-coverage
- name: us-central1-docker.pkg.dev/google-samples/microservices-demo/checkoutservice
  newName: checkoutservice
  newTag: local-coverage
- name: us-central1-docker.pkg.dev/google-samples/microservices-demo/shippingservice
  newName: shippingservice
  newTag: local-coverage

# Strategic merge patches to add tracing environment variables to all services
patches:
# Go services: Add coverage environment variable and volume
- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: productcatalogservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: GOCOVERDIR
              value: "/coverage-data"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "productcatalogservice"
            volumeMounts:
            - name: coverage-data
              mountPath: /coverage-data
          volumes:
          - name: coverage-data
            emptyDir: {}
- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: checkoutservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: GOCOVERDIR
              value: "/coverage-data"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "checkoutservice"
            volumeMounts:
            - name: coverage-data
              mountPath: /coverage-data
          volumes:
          - name: coverage-data
            emptyDir: {}
- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: shippingservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: GOCOVERDIR
              value: "/coverage-data"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "shippingservice"
            volumeMounts:
            - name: coverage-data
              mountPath: /coverage-data
          volumes:
          - name: coverage-data
            emptyDir: {}
# Node.js and other services: Add tracing only
- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: currencyservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "currencyservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: paymentservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "paymentservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: frontend
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "frontend"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: checkoutservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "checkoutservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: productcatalogservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "productcatalogservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: emailservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "emailservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: recommendationservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "recommendationservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: shippingservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "shippingservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: cartservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "cartservice"

- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: adservice
    spec:
      template:
        spec:
          containers:
          - name: server
            env:
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: "opentelemetrycollector:4317"
            - name: OTEL_SERVICE_NAME
              value: "adservice"
